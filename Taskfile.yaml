version: "3"

tasks:
  
  init:
    desc: "Init developers instruments"
    # cmd: go install github.com/cortesi/modd/cmd/modd@latest
    # cmd: go install github.com/jdudmesh/gomon@latest

  run:
    desc: "Run main application"
    cmd: go run ./cmd/sso --config=./config/local.yaml

  ctx:
    desc: "Run ctx application"
    cmd: go run ./cmd/context

  charm:
    desc: "Run charm application"
    cmd: go run ./cmd/charmlog

  val:
    desc: "Run val application"
    cmd: go run ./cmd/validator

  migrate:
    desc: "migrate DB"
    cmd: go run ./cmd/migrator --storage-path=./storage/sso.db --migrations-path=./migrations

  test:
    desc: "Tests app"
    cmd: go test -v -cover ./...

  migrate-test:
    desc: "migrate test DB"
    cmd: go run ./cmd/migrator --storage-path=./storage/sso.db --migrations-path=./tests/migrations --migrations-table=migrations_test

  build:
    desc: "Builds application"
    cmds:
      - 'go build -o bin/ ./cmd/sso/main.go'
    sources:
      - ./*.go,
      - ./**/*.go

  dev:
    desc: "Build and start app with file listener (hot reload)"
    deps: [build]
    silent: true
    watch: true
    cmd: ./bin/main --config=./config/local.yaml
    sources: 
      - ./*.go,
      - ./**/*.go